#!/bin/bash
export AWS_ACCESS_KEY_ID="<%=@awskey%>"
export AWS_SECRET_ACCESS_KEY="<%=@seckey%>"

daily_backup="/var/tmp/.mongo_daily_backup_timestamp"
day_ago="/var/tmp/.mongo_day_ago_timestamp"

touch -d "$(date -d '1 days ago')" $day_ago

# if no daily_backup timestamp, make one
if ! test -f $daily_backup ; then
  touch -d "$(date -d '2 days ago')" $daily_backup
  snapshot_period=daily
  keep_revisions=10
fi

# if daily_backup timestamp is older than a day_ago, make daily snapshot
if [ $daily_backup -ot $day_ago ] ; then
  touch $daily_backup
  snapshot_period=daily
  keep_revisions=10
else
  snapshot_period=hourly
  # we have this set up for every-other-hour so we can get 20 hours worth of hourly backups saving just 10
  keep_revisions=10
fi

/usr/local/bin/mongo-ec2-raid-snapshot \
		--quiet                                                      \
		--region <%= node['backups']['region'] %>                    \
		--description "Mongo RAID Snapshot (<%=@snapshot_tags%>)"    \
		--tags "<%=@snapshot_tags%>"                                 \
		--period $snapshot_period                                    \
		<%= node['backups']['mongo_volumes'].join(" ") %>

